<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangladesh Public Opinion Poll</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            onSnapshot,
            query,
            where,
            doc,
            updateDoc,
            deleteDoc,
            setDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdOPOmE1dhzyVRDLowr30GAi0LnjmDHt0",
            authDomain: "bangladesh-opinion-poll.firebaseapp.com",
            projectId: "bangladesh-opinion-poll",
            storageBucket: "bangladesh-opinion-poll.firebasestorage.app",
            messagingSenderId: "1006245972517",
            appId: "1:1006245972517:web:8bdda3e095c4375c438dcc",
            measurementId: "G-1RNP4Q7XX9"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseModules = {
            db,
            collection,
            addDoc,
            getDocs,
            onSnapshot,
            query,
            where,
            doc,
            updateDoc,
            deleteDoc,
            setDoc,
            writeBatch
        };
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #15803d; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .vote-pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-green-800 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-red-500 rounded-full"></div>
                    <h1 class="text-xl font-bold">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§</h1>
                </div>
                <button id="mobileMenuBtn" class="md:hidden text-2xl">‚ò∞</button>
                <div class="hidden md:flex space-x-6">
                    <a href="#home" class="nav-link hover:text-green-200 font-medium">Home</a>
                    <a href="#vote" class="nav-link hover:text-green-200 font-medium">Vote Now</a>
                    <a href="#results" class="nav-link hover:text-green-200 font-medium">Live Results</a>
                    <a href="#stats" class="nav-link hover:text-green-200 font-medium">Statistics</a>
                    <a href="#admin" class="nav-link hover:text-green-200 font-medium">Admin Panel</a>
                    <a href="#disclaimer" class="nav-link hover:text-green-200 font-medium">Disclaimer</a>
                </div>
            </div>
            <div id="mobileMenu" class="md:hidden hidden pb-4">
                <div class="flex flex-col space-y-3">
                    <a href="#home" class="nav-link hover:text-green-200">Home</a>
                    <a href="#vote" class="nav-link hover:text-green-200">Vote Now</a>
                    <a href="#results" class="nav-link hover:text-green-200">Live Results</a>
                    <a href="#stats" class="nav-link hover:text-green-200">Statistics</a>
                    <a href="#admin" class="nav-link hover:text-green-200">Admin Panel</a>
                    <a href="#disclaimer" class="nav-link hover:text-green-200">Disclaimer</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <!-- Home Section -->
        <section id="home" class="mb-16 fade-in">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-green-900 mb-4">Bangladesh Public Opinion Poll</h2>
                <p class="text-gray-600 text-lg max-w-3xl mx-auto">Participate in this non-official public opinion poll. This is a mock election for educational purposes only.</p>
            </div>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-green-200">
                    <div class="text-green-600 text-4xl mb-4">üó≥Ô∏è</div>
                    <h3 class="text-xl font-bold text-green-800 mb-2">Cast Your Vote</h3>
                    <p class="text-gray-600">Select your division, district, and constituency to vote.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-green-200">
                    <div class="text-green-600 text-4xl mb-4">üìä</div>
                    <h3 class="text-xl font-bold text-green-800 mb-2">Live Results</h3>
                    <p class="text-gray-600">Watch real-time vote counts across Bangladesh.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-green-200">
                    <div class="text-green-600 text-4xl mb-4">üîí</div>
                    <h3 class="text-xl font-bold text-green-800 mb-2">Secure & Private</h3>
                    <p class="text-gray-600">One vote per device ensures fair participation.</p>
                </div>
            </div>
            <div class="text-center mt-12">
                <a href="#vote" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg shadow-lg transition duration-300 inline-block">Start Voting Now ‚Üí</a>
            </div>
        </section>

        <!-- Vote Now Section -->
        <section id="vote" class="mb-16 fade-in">
            <h2 class="text-3xl font-bold text-green-900 mb-2 border-b pb-2">Vote Now</h2>
            <p class="text-gray-600 mb-6">Select your location and cast your vote for your preferred candidate.</p>
            <div id="voteStatus" class="hidden mb-6 p-4 rounded-lg"></div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between mb-8 relative">
                    <div class="step-item flex flex-col items-center z-10">
                        <div class="step-circle bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold">1</div>
                        <span class="mt-2 text-sm font-medium">Select Division</span>
                    </div>
                    <div class="step-item flex flex-col items-center z-10">
                        <div class="step-circle bg-gray-300 text-gray-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">2</div>
                        <span class="mt-2 text-sm font-medium">Select District</span>
                    </div>
                    <div class="step-item flex flex-col items-center z-10">
                        <div class="step-circle bg-gray-300 text-gray-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">3</div>
                        <span class="mt-2 text-sm font-medium">Select Constituency</span>
                    </div>
                    <div class="step-item flex flex-col items-center z-10">
                        <div class="step-circle bg-gray-300 text-gray-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">4</div>
                        <span class="mt-2 text-sm font-medium">Vote</span>
                    </div>
                    <div class="absolute top-5 left-10 right-10 h-1 bg-gray-300 z-0"></div>
                </div>
                
                <div id="step1" class="step-content">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Select Your Division</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="divisionList"></div>
                    <button id="nextToStep2" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next: Select District ‚Üí</button>
                </div>
                
                <div id="step2" class="step-content hidden">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Select Your District</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="districtList"></div>
                    <div class="flex justify-between mt-6">
                        <button id="backToStep1" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-lg">‚Üê Back to Divisions</button>
                        <button id="nextToStep3" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next: Select Constituency ‚Üí</button>
                    </div>
                </div>
                
                <div id="step3" class="step-content hidden">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Select Your Constituency</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="constituencyList"></div>
                    <div class="flex justify-between mt-6">
                        <button id="backToStep2" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-lg">‚Üê Back to Districts</button>
                        <button id="nextToStep4" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next: Vote for Candidate ‚Üí</button>
                    </div>
                </div>
                
                <div id="step4" class="step-content hidden">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Select Your Candidate</h3>
                    <p class="text-gray-600 mb-6" id="selectedLocation">Voting in: <span class="font-semibold"></span></p>
                    <div class="space-y-4" id="candidateList"></div>
                    <div class="flex justify-between mt-6">
                        <button id="backToStep3" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-lg">‚Üê Back to Constituencies</button>
                        <button id="submitVote" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg shadow-lg vote-pulse disabled:opacity-50 disabled:cursor-not-allowed" disabled>üó≥Ô∏è Cast Your Vote</button>
                    </div>
                </div>
                
                <div id="voteComplete" class="hidden text-center py-8">
                    <div class="text-green-600 text-6xl mb-4">‚úÖ</div>
                    <h3 class="text-2xl font-bold text-green-800 mb-2">Thank You for Voting!</h3>
                    <p class="text-gray-600 mb-6">Your vote has been recorded successfully.</p>
                    <p class="text-sm text-gray-500">You can view live results in the <a href="#results" class="text-green-600 font-medium">Live Results</a> section.</p>
                    <button id="voteAgain" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg">View Live Results ‚Üí</button>
                </div>
            </div>
        </section>

        <!-- Live Results Section -->
        <section id="results" class="mb-16 fade-in">
            <h2 class="text-3xl font-bold text-green-900 mb-2 border-b pb-2">Live Results</h2>
            <p class="text-gray-600 mb-6">Real-time vote counts across all constituencies.</p>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-green-800">National Vote Count</h3>
                    <div class="flex space-x-4 mt-4 md:mt-0">
                        <select id="resultsDivisionFilter" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="all">All Divisions</option>
                        </select>
                        <button id="refreshResults" class="bg-green-100 hover:bg-green-200 text-green-800 font-medium py-2 px-4 rounded-lg">Refresh Results</button>
                    </div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <div class="text-green-600 text-3xl mr-4">üìà</div>
                        <div>
                            <h4 class="font-bold text-green-800">Total Votes Cast Nationwide</h4>
                            <div class="flex items-baseline">
                                <span id="totalVotesCount" class="text-4xl font-bold text-green-700 mr-2">0</span>
                                <span class="text-gray-600">votes</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-green-800 mb-4">Top Candidates by Votes</h4>
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <canvas id="votesBarChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-green-800 mb-4">Vote Distribution</h4>
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <canvas id="votesPieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <h4 class="font-bold text-green-800 mb-4">Detailed Results by Constituency</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead>
                                <tr class="bg-green-50">
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Candidate</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Party</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Constituency</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Votes</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr><td colspan="5" class="py-8 text-center text-gray-500">Loading live results...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Panel Section -->
        <section id="admin" class="mb-16 fade-in">
            <h2 class="text-3xl font-bold text-green-900 mb-2 border-b pb-2">Admin Panel</h2>
            <p class="text-gray-600 mb-6">Administrative functions for managing the voting system. (Demo Only)</p>
            
            <!-- Admin Login -->
            <div id="adminLogin" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold text-green-800 mb-4">Admin Login</h3>
                <p class="text-gray-600 mb-4">Enter the admin password to access management functions.</p>
                <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                    <input type="password" id="adminPassword" placeholder="Enter admin password" class="border border-gray-300 rounded-lg px-4 py-2 flex-grow">
                    <button id="loginAdmin" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg">Login</button>
                </div>
                <p class="text-sm text-gray-500 mt-4">Demo password: <code class="bg-gray-100 px-2 py-1 rounded">admin123</code></p>
            </div>
            
            <!-- Admin Dashboard (Hidden by Default) -->
            <div id="adminDashboard" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-green-800">Admin Dashboard</h3>
                            <p class="text-green-700">You are logged in as Administrator</p>
                        </div>
                        <button id="logoutAdmin" class="bg-red-100 hover:bg-red-200 text-red-800 font-medium py-2 px-4 rounded-lg">Logout</button>
                    </div>
                </div>
                
                <!-- Admin Actions Grid -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Add Single Candidate -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="text-lg font-bold text-green-800 mb-4">Add New Candidate</h4>
                        <div class="space-y-4">
                            <div><label class="block text-gray-700 mb-2">Candidate Name</label><input type="text" id="candidateName" class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                            <div><label class="block text-gray-700 mb-2">Party</label><input type="text" id="candidateParty" class="w-full border border-gray-300 rounded-lg px-4 py-2"></div>
                            <div><label class="block text-gray-700 mb-2">Select Constituency</label><select id="adminConstituency" class="w-full border border-gray-300 rounded-lg px-4 py-2"></select></div>
                            <button id="addCandidateBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg">Add Candidate</button>
                        </div>
                    </div>
                    
                    <!-- Bulk Import System -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="text-lg font-bold text-green-800 mb-4">üì• Bulk Import Candidates (JSON)</h4>
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h5 class="font-bold text-blue-800 mb-2">JSON Format:</h5>
                                <pre class="text-sm bg-gray-100 p-3 rounded overflow-x-auto">[
  {
    "name": "Candidate Name",
    "party": "Party Name",
    "constituencyId": "dhaka_1",
    "constituencyName": "Dhaka-1"
  }
]</pre>
                            </div>
                            <div><label class="block text-gray-700 mb-2">Paste JSON Data:</label><textarea id="bulkCandidateJson" rows="6" class="w-full border border-gray-300 rounded-lg px-4 py-2 font-mono text-sm" placeholder='Paste your JSON array here...'></textarea></div>
                            <div class="flex space-x-4">
                                <button id="bulkImportBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Import Candidates</button>
                                <button id="downloadTemplateBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg">Download Template</button>
                            </div>
                            <div id="bulkImportStatus" class="hidden p-4 rounded-lg"></div>
                        </div>
                    </div>
                </div>
                
                <!-- System Management -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="text-lg font-bold text-green-800 mb-4">System Management</h4>
                        <div class="space-y-4">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <h5 class="font-bold text-red-800 mb-2">‚ö†Ô∏è Danger Zone</h5>
                                <p class="text-red-700 text-sm mb-4">These actions cannot be undone.</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <button id="resetAllVotes" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg">Reset All Votes</button>
                                    <button id="clearCandidates" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg">Clear All Candidates</button>
                                    <button id="exportAllData" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg">Export All Data</button>
                                    <button id="importFullData" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg">Import Full Data</button>
                                </div>
                            </div>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h5 class="font-bold text-yellow-800 mb-2">System Information</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between"><span class="text-gray-700">Total Votes</span><span class="font-bold" id="adminTotalVotes">0</span></div>
                                    <div class="flex justify-between"><span class="text-gray-700">Total Candidates</span><span class="font-bold" id="adminTotalCandidates">0</span></div>
                                    <div class="flex justify-between"><span class="text-gray-700">System Status</span><span class="font-bold text-green-600">Active</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Complete Database Management -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="text-lg font-bold text-green-800 mb-4">üóÉÔ∏è Complete Database Management</h4>
                        <div class="space-y-4">
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h5 class="font-bold text-gray-800 mb-2">üìä Database Statistics</h5>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><div class="text-sm text-gray-600">Total Constituencies</div><div class="text-2xl font-bold" id="totalConstituencies">12</div></div>
                                    <div><div class="text-sm text-gray-600">Total Candidates</div><div class="text-2xl font-bold" id="totalCandidatesDb">4</div></div>
                                </div>
                            </div>
                            <button id="loadSampleData" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg">Load Sample Bangladesh Data</button>
                            <button id="backupDatabase" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-2 px-4 rounded-lg">Backup Database to JSON</button>
                            <div id="databaseStatus" class="hidden p-4 rounded-lg"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Candidate List -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h4 class="text-lg font-bold text-green-800 mb-4">Manage Candidates</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead>
                                <tr class="bg-green-50">
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Name</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Party</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Constituency</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Votes</th>
                                    <th class="py-3 px-4 text-left font-bold text-green-800">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminCandidateTable">
                                <tr><td colspan="5" class="py-4 text-center text-gray-500">No candidates added yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Disclaimer Section -->
        <section id="disclaimer" class="fade-in">
            <div class="bg-white rounded-xl shadow-lg p-8 border border-red-300">
                <div class="text-center mb-6"><div class="text-red-600 text-5xl mb-4">‚ö†Ô∏è</div><h2 class="text-3xl font-bold text-red-800 mb-2">Important Disclaimer</h2></div>
                <div class="space-y-4 text-gray-700">
                    <p class="text-lg"><strong>This platform represents public opinion only and does not reflect official results of the Bangladesh Election Commission.</strong></p>
                    <p>This website is a demonstration of web development technologies and is designed for educational purposes only.</p>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-bold text-red-800 mb-2">Please Note:</h4>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>This is NOT an official election website</li>
                            <li>Results shown here are NOT authentic election results</li>
                            <li>This platform does not collect personal identification information</li>
                            <li>Votes are limited to one per device for demonstration purposes only</li>
                            <li>All data is stored in a Firebase database and can be reset by administrators</li>
                        </ul>
                    </div>
                    <p class="pt-4 border-t border-gray-300 text-center"><strong>For official election information in Bangladesh, please visit the <a href="https://www.ecs.gov.bd/" class="text-green-700 font-bold hover:underline" target="_blank">Bangladesh Election Commission website</a></strong></p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-green-900 text-white mt-16">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center space-x-2 mb-2">
                        <div class="w-8 h-8 bg-red-500 rounded-full"></div>
                        <h3 class="text-xl font-bold">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§</h3>
                    </div>
                    <p class="text-green-200">A demonstration of web development technologies</p>
                </div>
                <div class="text-center md:text-right">
                    <p class="text-green-200">¬© 2023 Bangladesh Public Opinion Poll</p>
                    <p class="text-green-300 text-sm mt-1">This is a mock election for educational purposes only</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript Application Code -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Get Firebase modules
            const { db, collection, addDoc, getDocs, onSnapshot, query, where, doc, updateDoc, deleteDoc, setDoc, writeBatch } = window.firebaseModules || {};
            
            if (!db) {
                console.error('Firebase not loaded.');
                showAlert('Firebase connection error.', 'error');
                return;
            }
            
            // Global Variables
            let selectedDivision = null;
            let selectedDistrict = null;
            let selectedConstituency = null;
            let selectedCandidate = null;
            let hasVoted = false;
            let deviceId = null;
            let allCandidates = [];
            let allVotes = [];
            let charts = {};
            
            // Complete Bangladesh Data Structure
            const bangladeshData = {
                divisions: [
                    { id: 'dhaka', name: 'Dhaka', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ' },
                    { id: 'chattogram', name: 'Chattogram', bnName: '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ' },
                    { id: 'rajshahi', name: 'Rajshahi', bnName: '‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ' },
                    { id: 'khulna', name: 'Khulna', bnName: '‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ' },
                    { id: 'barishal', name: 'Barishal', bnName: '‡¶¨‡¶∞‡¶ø‡¶∂‡¶æ‡¶≤' },
                    { id: 'sylhet', name: 'Sylhet', bnName: '‡¶∏‡¶ø‡¶≤‡ßá‡¶ü' },
                    { id: 'rangpur', name: 'Rangpur', bnName: '‡¶∞‡¶Ç‡¶™‡ßÅ‡¶∞' },
                    { id: 'mymensingh', name: 'Mymensingh', bnName: '‡¶Æ‡¶Ø‡¶º‡¶Æ‡¶®‡¶∏‡¶ø‡¶Ç‡¶π' }
                ],
                districts: {
                    dhaka: [
                        { id: 'dhaka_city', name: 'Dhaka City', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ ‡¶∏‡¶ø‡¶ü‡¶ø' },
                        { id: 'gazipur', name: 'Gazipur', bnName: '‡¶ó‡¶æ‡¶ú‡ßÄ‡¶™‡ßÅ‡¶∞' },
                        { id: 'narayanganj', name: 'Narayanganj', bnName: '‡¶®‡¶æ‡¶∞‡¶æ‡¶Ø‡¶º‡¶£‡¶ó‡¶û‡ßç‡¶ú' },
                        { id: 'narsingdi', name: 'Narsingdi', bnName: '‡¶®‡¶∞‡¶∏‡¶ø‡¶Ç‡¶¶‡ßÄ' },
                        { id: 'tangail', name: 'Tangail', bnName: '‡¶ü‡¶æ‡¶ô‡ßç‡¶ó‡¶æ‡¶á‡¶≤' }
                    ],
                    chattogram: [
                        { id: 'chattogram_city', name: 'Chattogram City', bnName: '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶∏‡¶ø‡¶ü‡¶ø' },
                        { id: 'cox_bazar', name: "Cox's Bazar", bnName: '‡¶ï‡¶ï‡ßç‡¶∏‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞' },
                        { id: 'chandpur', name: 'Chandpur', bnName: '‡¶ö‡¶æ‡¶Å‡¶¶‡¶™‡ßÅ‡¶∞' },
                        { id: 'feni', name: 'Feni', bnName: '‡¶´‡ßá‡¶®‡ßÄ' }
                    ],
                    rajshahi: [
                        { id: 'rajshahi_city', name: 'Rajshahi City', bnName: '‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ ‡¶∏‡¶ø‡¶ü‡¶ø' },
                        { id: 'bogura', name: 'Bogura', bnName: '‡¶¨‡¶ó‡ßÅ‡¶°‡¶º‡¶æ' },
                        { id: 'pabna', name: 'Pabna', bnName: '‡¶™‡¶æ‡¶¨‡¶®‡¶æ' },
                        { id: 'sirajganj', name: 'Sirajganj', bnName: '‡¶∏‡¶ø‡¶∞‡¶æ‡¶ú‡¶ó‡¶û‡ßç‡¶ú' }
                    ]
                },
                constituencies: {
                    dhaka_city: [
                        { id: 'dhaka_1', name: 'Dhaka-1', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ßß' },
                        { id: 'dhaka_2', name: 'Dhaka-2', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ß®' },
                        { id: 'dhaka_3', name: 'Dhaka-3', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ß©' },
                        { id: 'dhaka_4', name: 'Dhaka-4', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ß™' },
                        { id: 'dhaka_5', name: 'Dhaka-5', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ß´' },
                        { id: 'dhaka_6', name: 'Dhaka-6', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ß¨' },
                        { id: 'dhaka_7', name: 'Dhaka-7', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ß≠' },
                        { id: 'dhaka_8', name: 'Dhaka-8', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ßÆ' },
                        { id: 'dhaka_9', name: 'Dhaka-9', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ßØ' },
                        { id: 'dhaka_10', name: 'Dhaka-10', bnName: '‡¶¢‡¶æ‡¶ï‡¶æ-‡ßß‡ß¶' }
                    ],
                    gazipur: [
                        { id: 'gazipur_1', name: 'Gazipur-1', bnName: '‡¶ó‡¶æ‡¶ú‡ßÄ‡¶™‡ßÅ‡¶∞-‡ßß' },
                        { id: 'gazipur_2', name: 'Gazipur-2', bnName: '‡¶ó‡¶æ‡¶ú‡ßÄ‡¶™‡ßÅ‡¶∞-‡ß®' },
                        { id: 'gazipur_3', name: 'Gazipur-3', bnName: '‡¶ó‡¶æ‡¶ú‡ßÄ‡¶™‡ßÅ‡¶∞-‡ß©' }
                    ],
                    chattogram_city: [
                        { id: 'chattogram_1', name: 'Chattogram-1', bnName: '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ-‡ßß' },
                        { id: 'chattogram_2', name: 'Chattogram-2', bnName: '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ-‡ß®' }
                    ]
                }
            };
            
            // Utility Functions
            function generateDeviceId() {
                let deviceId = localStorage.getItem('vote_device_id');
                if (!deviceId) {
                    const navigatorInfo = navigator.userAgent + navigator.language + (screen.width * screen.height) + new Date().getTime();
                    deviceId = 'device_' + hashCode(navigatorInfo);
                    localStorage.setItem('vote_device_id', deviceId);
                }
                return deviceId;
            }
            
            function hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }
            
            function showAlert(message, type = 'info') {
                const alertDiv = document.getElementById('voteStatus');
                if (!alertDiv) return;
                alertDiv.className = `p-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' : type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-blue-100 text-blue-800 border border-blue-300'}`;
                alertDiv.innerHTML = message;
                alertDiv.classList.remove('hidden');
                setTimeout(() => alertDiv.classList.add('hidden'), 5000);
            }
            
            function showBulkStatus(message, type = 'info') {
                const statusDiv = document.getElementById('bulkImportStatus');
                if (!statusDiv) return;
                statusDiv.className = `p-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' : type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-blue-100 text-blue-800 border border-blue-300'}`;
                statusDiv.innerHTML = message;
                statusDiv.classList.remove('hidden');
                setTimeout(() => statusDiv.classList.add('hidden'), type === 'success' ? 10000 : 15000);
            }
            
            function showDatabaseStatus(message, type = 'info') {
                const statusDiv = document.getElementById('databaseStatus');
                if (!statusDiv) return;
                statusDiv.className = `p-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' : type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-blue-100 text-blue-800 border border-blue-300'}`;
                statusDiv.innerHTML = message;
                statusDiv.classList.remove('hidden');
                setTimeout(() => statusDiv.classList.add('hidden'), 10000);
            }
            
            async function checkVoteStatus() {
                deviceId = generateDeviceId();
                try {
                    const votesRef = collection(db, 'votes');
                    const q = query(votesRef, where('deviceId', '==', deviceId));
                    const querySnapshot = await getDocs(q);
                    hasVoted = !querySnapshot.empty;
                    if (hasVoted) {
                        showAlert('You have already voted from this device.', 'error');
                        disableVotingUI();
                    }
                    return hasVoted;
                } catch (error) {
                    console.error('Error checking vote status:', error);
                    return false;
                }
            }
            
            function disableVotingUI() {
                const voteButton = document.getElementById('submitVote');
                if (voteButton) {
                    voteButton.disabled = true;
                    voteButton.textContent = 'Already Voted';
                    voteButton.classList.remove('vote-pulse');
                    voteButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }
            
            // Initialize Navigation
            function initNavigation() {
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                const mobileMenu = document.getElementById('mobileMenu');
                if (mobileMenuBtn) {
                    mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
                }
                document.querySelectorAll('a.nav-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetId = this.getAttribute('href');
                        const targetElement = document.querySelector(targetId);
                        if (targetElement) {
                            if (!mobileMenu.classList.contains('hidden')) mobileMenu.classList.add('hidden');
                            window.scrollTo({ top: targetElement.offsetTop - 80, behavior: 'smooth' });
                        }
                    });
                });
            }
            
            // Initialize Voting UI
            function initVotingUI() {
                const divisionList = document.getElementById('divisionList');
                if (divisionList) {
                    bangladeshData.divisions.forEach(division => {
                        const div = document.createElement('button');
                        div.className = 'bg-white border border-green-300 hover:border-green-500 hover:bg-green-50 rounded-lg p-4 text-center transition duration-200';
                        div.innerHTML = `<div class="font-bold text-green-800">${division.name}</div><div class="text-gray-600 text-sm">${division.bnName}</div>`;
                        div.addEventListener('click', () => selectDivision(division));
                        divisionList.appendChild(div);
                    });
                }
                document.getElementById('nextToStep2')?.addEventListener('click', showStep2);
                document.getElementById('nextToStep3')?.addEventListener('click', showStep3);
                document.getElementById('nextToStep4')?.addEventListener('click', showStep4);
                document.getElementById('backToStep1')?.addEventListener('click', showStep1);
                document.getElementById('backToStep2')?.addEventListener('click', showStep2);
                document.getElementById('backToStep3')?.addEventListener('click', showStep3);
                document.getElementById('submitVote')?.addEventListener('click', submitVote);
                document.getElementById('voteAgain')?.addEventListener('click', () => window.scrollTo({ top: document.getElementById('results').offsetTop - 80, behavior: 'smooth' }));
            }
            
            // Voting Step Functions
            function selectDivision(division) {
                selectedDivision = division;
                document.querySelectorAll('#divisionList button').forEach(btn => {
                    btn.classList.remove('bg-green-100', 'border-green-500');
                    btn.classList.add('bg-white');
                });
                event.currentTarget.classList.add('bg-green-100', 'border-green-500');
                event.currentTarget.classList.remove('bg-white');
                document.getElementById('nextToStep2').disabled = false;
                updateStepIndicator(1);
            }
            
            function showStep1() {
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('step2').classList.add('hidden');
                updateStepIndicator(0);
            }
            
            function showStep2() {
                if (!selectedDivision) return;
                const districtList = document.getElementById('districtList');
                districtList.innerHTML = '';
                const districts = bangladeshData.districts[selectedDivision.id] || [];
                districts.forEach(district => {
                    const div = document.createElement('button');
                    div.className = 'bg-white border border-green-300 hover:border-green-500 hover:bg-green-50 rounded-lg p-4 text-center transition duration-200';
                    div.innerHTML = `<div class="font-bold text-green-800">${district.name}</div><div class="text-gray-600 text-sm">${district.bnName}</div>`;
                    div.addEventListener('click', () => selectDistrict(district));
                    districtList.appendChild(div);
                });
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                updateStepIndicator(1);
            }
            
            function selectDistrict(district) {
                selectedDistrict = district;
                document.querySelectorAll('#districtList button').forEach(btn => {
                    btn.classList.remove('bg-green-100', 'border-green-500');
                    btn.classList.add('bg-white');
                });
                event.currentTarget.classList.add('bg-green-100', 'border-green-500');
                event.currentTarget.classList.remove('bg-white');
                document.getElementById('nextToStep3').disabled = false;
                updateStepIndicator(2);
            }
            
            function showStep3() {
                if (!selectedDistrict) return;
                const constituencyList = document.getElementById('constituencyList');
                constituencyList.innerHTML = '';
                const constituencies = bangladeshData.constituencies[selectedDistrict.id] || [];
                constituencies.forEach(constituency => {
                    const div = document.createElement('button');
                    div.className = 'bg-white border border-green-300 hover:border-green-500 hover:bg-green-50 rounded-lg p-4 text-center transition duration-200';
                    div.innerHTML = `<div class="font-bold text-green-800">${constituency.name}</div><div class="text-gray-600 text-sm">${constituency.bnName}</div>`;
                    div.addEventListener('click', () => selectConstituency(constituency));
                    constituencyList.appendChild(div);
                });
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                updateStepIndicator(2);
            }
            
            function selectConstituency(constituency) {
                selectedConstituency = constituency;
                document.querySelectorAll('#constituencyList button').forEach(btn => {
                    btn.classList.remove('bg-green-100', 'border-green-500');
                    btn.classList.add('bg-white');
                });
                event.currentTarget.classList.add('bg-green-100', 'border-green-500');
                event.currentTarget.classList.remove('bg-white');
                document.getElementById('nextToStep4').disabled = false;
                updateStepIndicator(3);
            }
            
            async function showStep4() {
                if (!selectedConstituency) return;
                const selectedLocation = document.querySelector('#selectedLocation span');
                if (selectedLocation) selectedLocation.textContent = `${selectedConstituency.name}, ${selectedDistrict.name}, ${selectedDivision.name}`;
                const candidateList = document.getElementById('candidateList');
                candidateList.innerHTML = '';
                try {
                    const candidatesRef = collection(db, 'candidates');
                    const q = query(candidatesRef, where('constituencyId', '==', selectedConstituency.id));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        candidateList.innerHTML = `<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-4">üòï</div><p class="font-medium">No candidates found for this constituency.</p><p class="text-sm mt-2">Administrators can add candidates in the Admin Panel.</p></div>`;
                        document.getElementById('submitVote').disabled = true;
                        return;
                    }
                    let candidateCount = 0;
                    querySnapshot.forEach((doc) => {
                        const candidate = { id: doc.id, ...doc.data() };
                        candidateCount++;
                        const div = document.createElement('div');
                        div.className = 'candidate-item bg-white border border-gray-300 hover:border-green-400 rounded-lg p-4 transition duration-200';
                        div.innerHTML = `<div class="flex items-center"><div class="flex-shrink-0"><div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"><span class="text-green-800 font-bold">${candidateCount}</span></div></div><div class="ml-4 flex-grow"><div class="font-bold text-green-900">${candidate.name}</div><div class="text-gray-600">${candidate.party}</div></div><div class="flex-shrink-0"><div class="w-8 h-8 border-2 border-gray-300 rounded-full candidate-radio"></div></div></div>`;
                        div.addEventListener('click', () => selectCandidate(candidate, div));
                        candidateList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Error loading candidates:', error);
                    showAlert('Error loading candidates.', 'error');
                }
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step4').classList.remove('hidden');
                updateStepIndicator(3);
            }
            
            function selectCandidate(candidate, element) {
                selectedCandidate = candidate;
                document.querySelectorAll('.candidate-item').forEach(item => {
                    item.classList.remove('border-green-500', 'bg-green-50');
                    const radio = item.querySelector('.candidate-radio');
                    if (radio) radio.className = 'w-8 h-8 border-2 border-gray-300 rounded-full candidate-radio';
                });
                element.classList.add('border-green-500', 'bg-green-50');
                const radio = element.querySelector('.candidate-radio');
                if (radio) radio.className = 'w-8 h-8 border-2 border-green-500 rounded-full candidate-radio bg-green-500';
                document.getElementById('submitVote').disabled = false;
            }
            
            function updateStepIndicator(activeStep) {
                const steps = document.querySelectorAll('.step-circle');
                const line = document.querySelector('.absolute.h-1');
                steps.forEach((step, index) => {
                    if (index <= activeStep) {
                        step.classList.remove('bg-gray-300', 'text-gray-700');
                        step.classList.add('bg-green-600', 'text-white');
                    } else {
                        step.classList.remove('bg-green-600', 'text-white');
                        step.classList.add('bg-gray-300', 'text-gray-700');
                    }
                });
                if (line && activeStep > 0) {
                    const width = (activeStep / 3) * 100;
                    line.style.background = `linear-gradient(to right, #16a34a ${width}%, #d1d5db ${width}%)`;
                }
            }
            
            async function submitVote() {
                if (!selectedCandidate || !selectedConstituency || !selectedDistrict || !selectedDivision) {
                    showAlert('Please complete all voting steps.', 'error');
                    return;
                }
                if (hasVoted) {
                    showAlert('You have already voted from this device.', 'error');
                    return;
                }
                try {
                    const voteData = {
                        candidateId: selectedCandidate.id,
                        candidateName: selectedCandidate.name,
                        candidateParty: selectedCandidate.party,
                        constituencyId: selectedConstituency.id,
                        constituencyName: selectedConstituency.name,
                        districtId: selectedDistrict.id,
                        districtName: selectedDistrict.name,
                        divisionId: selectedDivision.id,
                        divisionName: selectedDivision.name,
                        deviceId: deviceId,
                        timestamp: new Date().toISOString(),
                        ipHash: hashCode(navigator.userAgent + new Date().getTime())
                    };
                    await addDoc(collection(db, 'votes'), voteData);
                    const candidateRef = doc(db, 'candidates', selectedCandidate.id);
                    const currentVotes = selectedCandidate.votes || 0;
                    await updateDoc(candidateRef, { votes: currentVotes + 1 });
                    hasVoted = true;
                    localStorage.setItem('has_voted', 'true');
                    document.getElementById('step4').classList.add('hidden');
                    document.getElementById('voteComplete').classList.remove('hidden');
                    disableVotingUI();
                    loadLiveResults();
                    showAlert('Your vote has been successfully recorded!', 'success');
                } catch (error) {
                    console.error('Error submitting vote:', error);
                    showAlert('Error submitting vote.', 'error');
                }
            }
            
            // Live Results Functions
            async function loadLiveResults() {
                try {
                    const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                    allCandidates = [];
                    candidatesSnapshot.forEach(doc => allCandidates.push({ id: doc.id, ...doc.data() }));
                    const votesSnapshot = await getDocs(collection(db, 'votes'));
                    allVotes = [];
                    votesSnapshot.forEach(doc => allVotes.push({ id: doc.id, ...doc.data() }));
                    document.getElementById('totalVotesCount').textContent = allVotes.length;
                    updateResultsTable();
                    updateResultsCharts();
                    updateStatistics();
                } catch (error) {
                    console.error('Error loading results:', error);
                }
            }
            
            function updateResultsTable() {
                const tableBody = document.getElementById('resultsTableBody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                const sortedCandidates = [...allCandidates].sort((a, b) => (b.votes || 0) - (a.votes || 0));
                if (sortedCandidates.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-gray-500">No votes recorded yet. Be the first to vote!</td></tr>`;
                    return;
                }
                const totalVotes = allVotes.length;
                sortedCandidates.forEach(candidate => {
                    const votes = candidate.votes || 0;
                    const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `<td class="py-3 px-4"><div class="font-medium text-green-900">${candidate.name}</div></td><td class="py-3 px-4"><span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">${candidate.party}</span></td><td class="py-3 px-4"><div class="text-gray-700">${candidate.constituencyName || 'N/A'}</div></td><td class="py-3 px-4"><div class="font-bold text-green-800">${votes}</div></td><td class="py-3 px-4"><div class="flex items-center"><div class="w-full bg-gray-200 rounded-full h-2 mr-2"><div class="bg-green-600 h-2 rounded-full" style="width: ${percentage}%"></div></div><span class="font-medium">${percentage}%</span></div></td>`;
                    tableBody.appendChild(row);
                });
            }
            
            function updateResultsCharts() {
                const topCandidates = [...allCandidates].sort((a, b) => (b.votes || 0) - (a.votes || 0)).slice(0, 5);
                const candidateNames = topCandidates.map(c => c.name);
                const candidateVotes = topCandidates.map(c => c.votes || 0);
                const candidateColors = ['#16a34a', '#dc2626', '#2563eb', '#ca8a04', '#9333ea'];
                const barCtx = document.getElementById('votesBarChart')?.getContext('2d');
                if (barCtx) {
                    if (charts.barChart) charts.barChart.destroy();
                    charts.barChart = new Chart(barCtx, {
                        type: 'bar', data: { labels: candidateNames, datasets: [{ label: 'Votes', data: candidateVotes, backgroundColor: candidateColors, borderColor: candidateColors.map(c => c.replace('0.8', '1')), borderWidth: 1 }] },
                        options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Top 5 Candidates' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                }
                const pieCtx = document.getElementById('votesPieChart')?.getContext('2d');
                if (pieCtx && topCandidates.length > 0) {
                    if (charts.pieChart) charts.pieChart.destroy();
                    charts.pieChart = new Chart(pieCtx, {
                        type: 'pie', data: { labels: candidateNames, datasets: [{ data: candidateVotes, backgroundColor: candidateColors, borderWidth: 1 }] },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            }
            
            function updateStatistics() {
                if (allCandidates.length === 0) return;
                const totalVotes = allVotes.length;
                const avgVotes = totalVotes > 0 ? Math.round(totalVotes / allCandidates.length) : 0;
                const partyVotes = {};
                allCandidates.forEach(candidate => partyVotes[candidate.party] = (partyVotes[candidate.party] || 0) + (candidate.votes || 0));
                let popularParty = 'N/A', maxPartyVotes = 0;
                for (const [party, votes] of Object.entries(partyVotes)) {
                    if (votes > maxPartyVotes) { maxPartyVotes = votes; popularParty = party; }
                }
                document.getElementById('avgVotes').textContent = avgVotes;
                document.getElementById('popularParty').textContent = popularParty;
                document.getElementById('totalCandidates').textContent = allCandidates.length;
                updateDivisionChart();
            }
            
            function updateDivisionChart() {
                const divisionVotes = {};
                bangladeshData.divisions.forEach(div => divisionVotes[div.name] = 0);
                allVotes.forEach(vote => { if (vote.divisionName && divisionVotes[vote.divisionName] !== undefined) divisionVotes[vote.divisionName]++; });
                const divisionCtx = document.getElementById('divisionChart')?.getContext('2d');
                if (divisionCtx) {
                    if (charts.divisionChart) charts.divisionChart.destroy();
                    const divisionNames = Object.keys(divisionVotes);
                    const divisionVoteCounts = Object.values(divisionVotes);
                    charts.divisionChart = new Chart(divisionCtx, {
                        type: 'doughnut', data: { labels: divisionNames, datasets: [{ data: divisionVoteCounts, backgroundColor: ['#16a34a', '#dc2626', '#2563eb', '#ca8a04', '#9333ea', '#0891b2', '#7c3aed', '#ea580c'] }] },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            }
            
            // Admin Panel Functions
            function initAdminPanel() {
                document.getElementById('loginAdmin')?.addEventListener('click', loginAdmin);
                document.getElementById('logoutAdmin')?.addEventListener('click', logoutAdmin);
                document.getElementById('adminPassword')?.addEventListener('keypress', function(e) { if (e.key === 'Enter') loginAdmin(); });
                document.getElementById('addCandidateBtn')?.addEventListener('click', addCandidate);
                document.getElementById('resetAllVotes')?.addEventListener('click', resetAllVotes);
                document.getElementById('clearCandidates')?.addEventListener('click', clearAllCandidates);
                document.getElementById('bulkImportBtn')?.addEventListener('click', bulkImportCandidates);
                document.getElementById('downloadTemplateBtn')?.addEventListener('click', downloadTemplate);
                document.getElementById('exportAllData')?.addEventListener('click', exportAllData);
                document.getElementById('importFullData')?.addEventListener('click', importFullData);
                document.getElementById('loadSampleData')?.addEventListener('click', loadSampleBangladeshData);
                document.getElementById('backupDatabase')?.addEventListener('click', backupDatabaseToJSON);
                loadAdminConstituencies();
                loadAdminCandidates();
            }
            
            function loginAdmin() {
                const password = document.getElementById('adminPassword').value;
                if (password === 'admin123') {
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    showAlert('Admin login successful!', 'success');
                    loadAdminData();
                } else {
                    showAlert('Incorrect password. Demo password is "admin123"', 'error');
                }
            }
            
            function logoutAdmin() {
                document.getElementById('adminLogin').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
                document.getElementById('adminPassword').value = '';
                showAlert('Logged out successfully.', 'info');
            }
            
            async function loadAdminData() {
                try {
                    const votesSnapshot = await getDocs(collection(db, 'votes'));
                    document.getElementById('adminTotalVotes').textContent = votesSnapshot.size;
                    const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                    document.getElementById('adminTotalCandidates').textContent = candidatesSnapshot.size;
                } catch (error) {
                    console.error('Error loading admin data:', error);
                }
            }
            
            function loadAdminConstituencies() {
                const select = document.getElementById('adminConstituency');
                if (!select) return;
                select.innerHTML = '<option value="">Select Constituency</option>';
                for (const [districtId, constituencies] of Object.entries(bangladeshData.constituencies)) {
                    const district = Object.values(bangladeshData.districts).flat().find(d => d.id === districtId);
                    if (district) {
                        const division = Object.values(bangladeshData.divisions).find(div => bangladeshData.districts[div.id]?.some(d => d.id === districtId));
                        constituencies.forEach(constituency => {
                            const option = document.createElement('option');
                            option.value = constituency.id;
                            option.textContent = `${constituency.name} (${district.name}, ${division?.name || 'N/A'})`;
                            select.appendChild(option);
                        });
                    }
                }
            }
            
            async function loadAdminCandidates() {
                const tableBody = document.getElementById('adminCandidateTable');
                if (!tableBody) return;
                try {
                    const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                    tableBody.innerHTML = '';
                    if (candidatesSnapshot.empty) {
                        tableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No candidates added yet.</td></tr>`;
                        return;
                    }
                    candidatesSnapshot.forEach(doc => {
                        const candidate = { id: doc.id, ...doc.data() };
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-50';
                        row.innerHTML = `<td class="py-3 px-4">${candidate.name}</td><td class="py-3 px-4"><span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">${candidate.party}</span></td><td class="py-3 px-4">${candidate.constituencyName || 'N/A'}</td><td class="py-3 px-4 font-bold">${candidate.votes || 0}</td><td class="py-3 px-4"><button class="delete-candidate bg-red-100 hover:bg-red-200 text-red-800 text-xs font-medium px-3 py-1 rounded" data-id="${candidate.id}">Delete</button></td>`;
                        tableBody.appendChild(row);
                    });
                    document.querySelectorAll('.delete-candidate').forEach(button => {
                        button.addEventListener('click', function() {
                            const candidateId = this.getAttribute('data-id');
                            deleteCandidate(candidateId);
                        });
                    });
                } catch (error) {
                    console.error('Error loading admin candidates:', error);
                }
            }
            
            async function addCandidate() {
                const name = document.getElementById('candidateName').value.trim();
                const party = document.getElementById('candidateParty').value.trim();
                const constituencyId = document.getElementById('adminConstituency').value;
                if (!name || !party || !constituencyId) {
                    showAlert('Please fill all fields and select a constituency.', 'error');
                    return;
                }
                let constituencyName = '';
                for (const [districtId, constituencies] of Object.entries(bangladeshData.constituencies)) {
                    const constituency = constituencies.find(c => c.id === constituencyId);
                    if (constituency) { constituencyName = constituency.name; break; }
                }
                try {
                    await addDoc(collection(db, 'candidates'), { name: name, party: party, constituencyId: constituencyId, constituencyName: constituencyName, votes: 0 });
                    document.getElementById('candidateName').value = '';
                    document.getElementById('candidateParty').value = '';
                    document.getElementById('adminConstituency').value = '';
                    loadAdminCandidates();
                    loadLiveResults();
                    showAlert(`Candidate "${name}" added successfully!`, 'success');
                } catch (error) {
                    console.error('Error adding candidate:', error);
                    showAlert('Error adding candidate.', 'error');
                }
            }
            
            async function deleteCandidate(candidateId) {
                if (!confirm('Are you sure you want to delete this candidate?')) return;
                try {
                    await deleteDoc(doc(db, 'candidates', candidateId));
                    loadAdminCandidates();
                    loadLiveResults();
                    showAlert('Candidate deleted successfully.', 'success');
                } catch (error) {
                    console.error('Error deleting candidate:', error);
                    showAlert('Error deleting candidate.', 'error');
                }
            }
            
            async function resetAllVotes() {
                if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL votes. Are you sure?')) return;
                try {
                    const votesSnapshot = await getDocs(collection(db, 'votes'));
                    const deletePromises = [];
                    votesSnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                    await Promise.all(deletePromises);
                    const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                    const updatePromises = [];
                    candidatesSnapshot.forEach(doc => updatePromises.push(updateDoc(doc.ref, { votes: 0 })));
                    await Promise.all(updatePromises);
                    localStorage.removeItem('has_voted');
                    hasVoted = false;
                    const voteButton = document.getElementById('submitVote');
                    if (voteButton && !hasVoted) {
                        voteButton.disabled = false;
                        voteButton.textContent = 'üó≥Ô∏è Cast Your Vote';
                        voteButton.classList.add('vote-pulse');
                        voteButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    }
                    loadLiveResults();
                    loadAdminData();
                    showAlert('All votes have been reset successfully.', 'success');
                } catch (error) {
                    console.error('Error resetting votes:', error);
                    showAlert('Error resetting votes.', 'error');
                }
            }
            
            async function clearAllCandidates() {
                if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL candidates. Are you sure?')) return;
                try {
                    const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                    const deletePromises = [];
                    candidatesSnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                    await Promise.all(deletePromises);
                    loadAdminCandidates();
                    loadLiveResults();
                    showAlert('All candidates have been deleted.', 'success');
                } catch (error) {
                    console.error('Error clearing candidates:', error);
                    showAlert('Error clearing candidates.', 'error');
                }
            }
            
            // Bulk Import System
            async function bulkImportCandidates() {
                const jsonText = document.getElementById('bulkCandidateJson').value.trim();
                if (!jsonText) {
                    showBulkStatus('Please paste JSON data first.', 'error');
                    return;
                }
                try {
                    const candidates = JSON.parse(jsonText);
                    if (!Array.isArray(candidates)) {
                        showBulkStatus('JSON must be an array of candidates.', 'error');
                        return;
                    }
                    if (candidates.length === 0) {
                        showBulkStatus('No candidates found in JSON.', 'error');
                        return;
                    }
                    showBulkStatus(`Importing ${candidates.length} candidates...`, 'info');
                    let successCount = 0, errorCount = 0;
                    for (const candidate of candidates) {
                        try {
                            if (!candidate.name || !candidate.party || !candidate.constituencyId || !candidate.constituencyName) {
                                errorCount++; continue;
                            }
                            await addDoc(collection(db, 'candidates'), {
                                name: candidate.name,
                                party: candidate.party,
                                constituencyId: candidate.constituencyId,
                                constituencyName: candidate.constituencyName,
                                votes: candidate.votes || 0,
                                symbol: candidate.symbol || '',
                                division: candidate.division || 'Dhaka',
                                district: candidate.district || 'Dhaka City'
                            });
                            successCount++;
                            if (successCount % 5 === 0) {
                                showBulkStatus(`Imported ${successCount}/${candidates.length} candidates...`, 'info');
                            }
                        } catch (error) {
                            errorCount++;
                        }
                    }
                    showBulkStatus(`‚úÖ Successfully imported ${successCount} candidates. ${errorCount} failed.`, 'success');
                    document.getElementById('bulkCandidateJson').value = '';
                    setTimeout(() => { loadAdminCandidates(); loadLiveResults(); }, 1000);
                } catch (error) {
                    showBulkStatus('‚ùå Invalid JSON format.', 'error');
                }
            }
            
            function downloadTemplate() {
                const template = [{
                    "name": "Sheikh Hasina",
                    "party": "Awami League",
                    "constituencyId": "dhaka_1",
                    "constituencyName": "Dhaka-1",
                    "votes": 0,
                    "symbol": "‡¶®‡ßå‡¶ï‡¶æ",
                    "division": "Dhaka",
                    "district": "Dhaka City"
                }, {
                    "name": "Mirza Abbas",
                    "party": "Bangladesh Nationalist Party (BNP)",
                    "constituencyId": "dhaka_8",
                    "constituencyName": "Dhaka-8",
                    "votes": 0,
                    "symbol": "‡¶ß‡¶æ‡¶® ‡¶∂‡ßÄ‡¶∑",
                    "division": "Dhaka",
                    "district": "Dhaka City"
                }];
                const dataStr = JSON.stringify(template, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', 'candidates_template.json');
                linkElement.click();
                showBulkStatus('üìÑ Template downloaded. Edit it and paste back for bulk import.', 'info');
            }
            
            async function exportAllData() {
                try {
                    const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                    const votesSnapshot = await getDocs(collection(db, 'votes'));
                    const candidates = [];
                    const votes = [];
                    candidatesSnapshot.forEach(doc => candidates.push({ id: doc.id, ...doc.data() }));
                    votesSnapshot.forEach(doc => votes.push({ id: doc.id, ...doc.data() }));
                    const exportData = {
                        timestamp: new Date().toISOString(),
                        totalCandidates: candidates.length,
                        totalVotes: votes.length,
                        candidates: candidates,
                        votes: votes,
                        bangladeshData: bangladeshData
                    };
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', 'bangladesh_voting_export.json');
                    linkElement.click();
                    showDatabaseStatus('‚úÖ All data exported successfully!', 'success');
                } catch (error) {
                    console.error('Error exporting data:', error);
                    showDatabaseStatus('‚ùå Error exporting data.', 'error');
                }
            }
            
            async function importFullData() {
                const jsonText = prompt('Paste the full JSON export data:');
                if (!jsonText) return;
                try {
                    const importData = JSON.parse(jsonText);
                    if (!importData.candidates || !Array.isArray(importData.candidates)) {
                        showDatabaseStatus('Invalid import data format.', 'error');
                        return;
                    }
                    if (confirm(`This will import ${importData.candidates.length} candidates and ${importData.votes?.length || 0} votes. Continue?`)) {
                        showDatabaseStatus('Importing data...', 'info');
                        // Clear existing data
                        const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                        const deletePromises = [];
                        candidatesSnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                        await Promise.all(deletePromises);
                        // Import new candidates
                        const batch = writeBatch(db);
                        importData.candidates.forEach(candidate => {
                            const newDocRef = doc(collection(db, 'candidates'));
                            batch.set(newDocRef, candidate);
                        });
                        await batch.commit();
                        showDatabaseStatus(`‚úÖ Successfully imported ${importData.candidates.length} candidates.`, 'success');
                        setTimeout(() => { loadAdminCandidates(); loadLiveResults(); }, 1000);
                    }
                } catch (error) {
                    console.error('Error importing data:', error);
                    showDatabaseStatus('‚ùå Error importing data.', 'error');
                }
            }
            
            async function loadSampleBangladeshData() {
                if (!confirm('Load sample Bangladesh election data? This will add sample candidates.')) return;
                const sampleData = [
                    { name: "Sheikh Hasina", party: "Awami League", constituencyId: "dhaka_1", constituencyName: "Dhaka-1", votes: 0, symbol: "‡¶®‡ßå‡¶ï‡¶æ" },
                    { name: "Mirza Abbas", party: "Bangladesh Nationalist Party (BNP)", constituencyId: "dhaka_8", constituencyName: "Dhaka-8", votes: 0, symbol: "‡¶ß‡¶æ‡¶® ‡¶∂‡ßÄ‡¶∑" },
                    { name: "Muhammad Nasiruddin Patwary", party: "National Citizen Party (NCP)", constituencyId: "dhaka_8", constituencyName: "Dhaka-8", votes: 0, symbol: "‡¶®‡¶æ‡¶∞‡¶ï‡ßá‡¶≤" },
                    { name: "Khaleda Zia", party: "Bangladesh Nationalist Party (BNP)", constituencyId: "dhaka_2", constituencyName: "Dhaka-2", votes: 0, symbol: "‡¶ß‡¶æ‡¶® ‡¶∂‡ßÄ‡¶∑" },
                    { name: "Hasanul Haq Inu", party: "Jatiya Samajtantrik Dal", constituencyId: "dhaka_3", constituencyName: "Dhaka-3", votes: 0, symbol: "‡¶§‡ßã‡¶∞‡¶£" }
                ];
                try {
                    showDatabaseStatus('Loading sample data...', 'info');
                    for (const candidate of sampleData) {
                        await addDoc(collection(db, 'candidates'), candidate);
                    }
                    showDatabaseStatus('‚úÖ Sample Bangladesh data loaded successfully!', 'success');
                    setTimeout(() => { loadAdminCandidates(); loadLiveResults(); }, 1000);
                } catch (error) {
                    console.error('Error loading sample data:', error);
                    showDatabaseStatus('‚ùå Error loading sample data.', 'error');
                }
            }
            
            async function backupDatabaseToJSON() {
                try {
                    const candidatesSnapshot = await getDocs(collection(db, 'candidates'));
                    const votesSnapshot = await getDocs(collection(db, 'votes'));
                    const candidates = [];
                    const votes = [];
                    candidatesSnapshot.forEach(doc => candidates.push({ id: doc.id, ...doc.data() }));
                    votesSnapshot.forEach(doc => votes.push({ id: doc.id, ...doc.data() }));
                    const backupData = {
                        backupDate: new Date().toISOString(),
                        candidates: candidates,
                        votes: votes,
                        totalCandidates: candidates.length,
                        totalVotes: votes.length
                    };
                    const dataStr = JSON.stringify(backupData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', `bangladesh_voting_backup_${new Date().toISOString().split('T')[0]}.json`);
                    linkElement.click();
                    showDatabaseStatus('‚úÖ Database backup created and downloaded.', 'success');
                } catch (error) {
                    console.error('Error creating backup:', error);
                    showDatabaseStatus('‚ùå Error creating backup.', 'error');
                }
            }
            
            // Setup Firebase Listeners
            function setupFirestoreListeners() {
                if (!db) return;
                onSnapshot(collection(db, 'votes'), (snapshot) => {
                    allVotes = [];
                    snapshot.forEach(doc => allVotes.push({ id: doc.id, ...doc.data() }));
                    document.getElementById('totalVotesCount').textContent = allVotes.length;
                    updateResultsTable();
                    updateResultsCharts();
                    updateStatistics();
                });
                onSnapshot(collection(db, 'candidates'), (snapshot) => {
                    allCandidates = [];
                    snapshot.forEach(doc => allCandidates.push({ id: doc.id, ...doc.data() }));
                    updateResultsTable();
                    updateResultsCharts();
                    updateStatistics();
                    loadAdminCandidates();
                });
            }
            
            // Initialize Application
            initNavigation();
            initVotingUI();
            initAdminPanel();
            await checkVoteStatus();
            await loadLiveResults();
            setupFirestoreListeners();
            document.getElementById('refreshResults')?.addEventListener('click', loadLiveResults);
            
            console.log('Bangladesh Public Opinion Poll initialized successfully!');
        });
    </script>
</body>
</html>
